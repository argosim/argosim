package at.ac.univie.knasmueller.hulk;

import java.io.File;
import java.io.FileNotFoundException;
import java.io.IOException;
import java.io.InputStream;
import java.io.OutputStream;
import java.io.InputStream;
import java.io.FileOutputStream;
import java.io.ObjectOutputStream;
import java.io.FileInputStream;
import java.io.ObjectInputStream;

import at.cibiv.ngs.tools.util.FileUtils;

public class HulkFile {
	HulkProject hulkProject;
	File originalFile, tempCopyFile;
	boolean isRemoved;
	int tempFileId;

	public enum ConstructorType {
		HulkCopy, HulkNoCopy
	}

	public int getTempFileId() {
		return tempFileId;
	}

	public void setTempFileId(int tempFileId) {
		this.tempFileId = tempFileId;
	}

	private void copyFileToTemp(File from, File to) throws IOException {
		if(!from.exists()) {
			throw new IOException("Could not find source-file: " + from);
		}
		InputStream is = null;
		OutputStream os = null;
		try {
			is = new FileInputStream(from);
			os = new FileOutputStream(to);
			byte[] buffer = new byte[1024];
			int length;
			while ((length = is.read(buffer)) > 0) {
				os.write(buffer, 0, length);
			}
		} finally {
			is.close();
			os.close();
		}
	}

	public HulkFile(HulkProject hulkProject, File file) throws IOException {
		this(hulkProject, file, ConstructorType.HulkCopy);
	}

	public HulkFile(HulkProject hulkProject, File file, ConstructorType ct)
			throws IOException {
		/* creates a copy of the file to the tempDir */
		/**
		 * ConstructorType specifies whether a temporary copy of the file should
		 * be created or not
		 **/
		this.hulkProject = hulkProject;
		if (ct == ConstructorType.HulkCopy) {
			File tempCopy = FileUtils.createTempFile(
					this.hulkProject.getTempDir(), "hulkFile_");
			System.out.println("Copy file to temp: " + file + ", " + tempCopy);
			copyFileToTemp(file, tempCopy);
			this.originalFile = file;
			this.tempCopyFile = tempCopy;
			this.isRemoved = false;
			this.tempFileId = this.addTempFile(this);
		} else {
			/* no copying necessary, just take the file as a temp file */
			this.originalFile = file;
			this.tempCopyFile = file;
			this.isRemoved = false;
			this.tempFileId = this.addTempFile(this);
		}
		
	}

	int addTempFile(HulkFile file) {
		System.out.println("Add temp file: " + file.getFileAbs());
		return this.hulkProject.addTempFile(file);
	}

	public void remove() {
		/* removes this file from the tempDir */

		// check if file actually exists
		if (!this.getFileAbs().exists())
			throw new RuntimeException("Tried to delete a non-existing file: "
					+ this.getFileAbs());

		{
			boolean success = this.getFileAbs().delete();
			if (!success) {
				throw new RuntimeException("Could not delete the file "
						+ this.getFileAbs());
			}
		}

		this.hulkProject.tempFiles.remove(this.tempFileId);

	}

	public HulkFile insert(HulkFile insertFile, EventPosition pos)
			throws IOException {

		PasteEvent pe = new PasteEvent(this.getFileAbs(),
				insertFile.getFileAbs(), this.hulkProject.getTempDir(), pos,
				this.hulkProject.getILogger());
		File result = (File) pe.processSequence();
		HulkFile resultHulk = new HulkFile(this.hulkProject, result, ConstructorType.HulkNoCopy);
		/* use HulkNoCopy because processSequence already creates a temp file */
		return resultHulk;

	}

	public File getFileAbs() {
		/**
		 * returns absolute path of this temp dir
		 */
		return tempCopyFile;
	}

	public HulkFile copy(EventPosition pos, long length) throws IOException {
		CopyEvent ce = new CopyEvent(this.getFileAbs(),
				this.hulkProject.getTempDir(), pos, length,
				this.hulkProject.getILogger());
		File result = (File) ce.processSequence();
		HulkFile resultHulk = new HulkFile(this.hulkProject, result, ConstructorType.HulkNoCopy);
		/* use HulkNoCopy because processSequence() already creates a temp file in the temp dir */

		return resultHulk;
	}

	public HulkFile[] cut(EventPosition pos, long length) throws IOException {
		// TODO changeme
		HulkFile[] hfs = new HulkFile[] {
				new HulkFile(this.hulkProject, this.originalFile),
				new HulkFile(this.hulkProject, this.originalFile) };

		return hfs;
	}

	public void save() throws IOException {
		/**
		 * saves this file to the result-folder using a generated name
		 */
		this.save(null);
	}

	public void save(String fileName) throws IOException {
		/**
		 * saves this fiels to the result-folder, naming it fileName.
		 */
		if (fileName == null) {
			fileName = "result";
		}
		InputStream is = null;
		OutputStream os = null;
		try {
			File outFile = new File(this.hulkProject.getResultDir() + "/"
					+ fileName + ".fasta");
			int i = 1;
			while (outFile.exists()) {
				outFile = new File(this.hulkProject.getResultDir() + "/"
						+ fileName + "_" + i + ".fasta");
				i++;
			}
			is = new FileInputStream(getFileAbs());
			os = new FileOutputStream(outFile);
			byte[] buffer = new byte[1024];
			int length;
			while ((length = is.read(buffer)) > 0) {
				os.write(buffer, 0, length);
			}
		} finally {
			is.close();
			os.close();
		}
	}

	public static void main(String[] args) {

	}

}
